name: Tag and Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1.10'

      - name: Install ReleaseNotes.jl
        run: julia -e 'using Pkg; Pkg.add("ReleaseNotes")'

      - name: Generate release notes
        id: notes
        run: |
          julia -e '
            using ReleaseNotes
            notes = ReleaseNotes.collect_notes()
            open("release_notes.md", "w") do io
                println(io, notes)
            end
          '

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}